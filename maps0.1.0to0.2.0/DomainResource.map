map "http://chmed16af.emediplan.ch/fhir/StructureMap/DomainResource0.1.0to0.2.0" = "Conversion for DomainResource"

uses "http://hl7.org/fhir/StructureDefinition/DomainResource" as source
uses "http://hl7.org/fhir/StructureDefinition/DomainResource" as target

imports "http://chmed16af.emediplan.ch/fhir/StructureMap/*0.1.0to0.2.0"

group DomainResource(source src : DomainResource, target tgt : DomainResource) extends Resource {
  src.text as v -> tgt.text = v;
  src.contained as v -> tgt.contained = v;
  src.extension as v where (url.startsWith('http://chmed16af.emediplan.ch/fhir/StructureDefinition/') and url.startsWith('http://chmed16af.emediplan.ch/fhir/StructureDefinition/chmed16af-receiver').not()) -> tgt.extension = create('Extension') as e then extensionPrivateField(v, e) "SettingPrivatefields";
  src.extension as v where (url.startsWith('http://chmed16af.emediplan.ch/fhir/StructureDefinition/') and url.startsWith('http://chmed16af.emediplan.ch/fhir/StructureDefinition/chmed16af-receiver').not()).not() -> tgt.extension = v;
  src.modifierExtension as v -> tgt.modifierExtension = v;
}

group extensionPrivateField(source src : Extension, target tgt : Extension) {
  src.url as v -> tgt.url = 'http://chmed16af.emediplan.ch/fhir/StructureDefinition/chmed16af-privatefield', tgt.extension = create('Extension') as e then extensionPrivateFieldName(v, e) "SettingPrivatefieldName";
  src.value as v -> tgt.extension = create('Extension') as e then extensionPrivateFieldValue(v, e) "SettingPrivatefieldValue";
}

group extensionPrivateFieldName(source src : uri, target tgt : Extension) {
  src as v -> 
    tgt.url = 'name',
    tgt.value = evaluate(v, v.substring(55)) "settingName";
}

group extensionPrivateFieldValue(source src : string, target tgt : Extension) {
  src as v -> 
    tgt.url = 'value',
    tgt.value = v "settingValue";
}